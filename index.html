// Google Apps Script for CAMP2026
const SHEET_NAME = "CAMP2026";

function doPost(e) {
  const data = JSON.parse(e.postData.contents);
  const ss = SpreadsheetApp.openById("1WbNJJHqzWgRDQUThxxrK9-odKmEE8jjLIkCdFZcKhKo");
  const sheet = ss.getSheetByName(SHEET_NAME);
  
  // Check duplicate (Name + Age + Church)
  const allData = sheet.getDataRange().getValues();
  for (let i = 1; i < allData.length; i++) {
    if (allData[i][0] === data.name && allData[i][1] == data.age && allData[i][5] === data.church) {
      return ContentService.createTextOutput(JSON.stringify({status:"duplicate"})).setMimeType(ContentService.MimeType.JSON);
    }
  }

  // Append new entry: Name, Age, Sex, Accommodation, Contact, Church, ID, Present
  sheet.appendRow([data.name, data.age, data.sex, data.accommodation, data.contact, data.church, data.id, "No"]);
  return ContentService.createTextOutput(JSON.stringify({status:"success"})).setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  const id = e.parameter.id;
  if (!id) return ContentService.createTextOutput(JSON.stringify({found:false})).setMimeType(ContentService.MimeType.JSON);

  const ss = SpreadsheetApp.openById("1WbNJJHqzWgRDQUThxxrK9-odKmEE8jjLIkCdFZcKhKo");
  const sheet = ss.getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][6] === id) {
      // Mark Present
      sheet.getRange(i + 1, 8).setValue("Yes");
      return ContentService.createTextOutput(JSON.stringify({
        found: true,
        name: data[i][0],
        age: data[i][1],
        sex: data[i][2],
        accommodation: data[i][3],
        contact: data[i][4],
        church: data[i][5]
      })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  return ContentService.createTextOutput(JSON.stringify({found:false})).setMimeType(ContentService.MimeType.JSON);
}
