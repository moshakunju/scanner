<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Camp Attendance Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{ font-family: Arial; margin:0; padding:0; text-align:center; background:#f0f0f0;}
  h2{margin:10px;}
  #preview{width: 100%; max-width: 500px; height: 400px; border:1px solid #ccc; margin:auto; }
  #msg{margin-top:10px; font-size:18px; font-weight:bold;}
</style>
</head>
<body>
<h2>Camp Attendance Scanner</h2>
<video id="preview"></video>
<div id="msg">Initializing camera...</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqR1FoRQL3K_59LBkwOcpgr-jAmAmDonSNfpROKDyA8i-EmnvOwO3od3f0ZX4p3za2DQ/exec";
const msg = document.getElementById("msg");
const codeReader = new ZXing.BrowserQRCodeReader();

navigator.mediaDevices.getUserMedia({video: {facingMode:"environment"}})
.then(stream => {
  document.getElementById("preview").srcObject = stream;
  document.getElementById("preview").play();

  codeReader.decodeFromVideoDevice(null, 'preview', (result, err) => {
    if(result){
      const id = result.text;
      msg.innerText = "Scanning: "+id;

      // Call Apps Script
      const script = document.createElement("script");
      const url = `${SCRIPT_URL}?callback=handleScan&action=scan&id=${encodeURIComponent(id)}`;
      script.src = url;
      document.body.appendChild(script);
    }
  });
})
.catch(err => {
  msg.innerText = "Error accessing camera: " + err;
});

function handleScan(res){
  if(res.status === "ok"){
    msg.style.color="green";
    msg.innerText = `✅ ${res.name}, Age: ${res.age} – marked Present`;
  } else if(res.status === "already_present"){
    msg.style.color="orange";
    msg.innerText = `⚠️ ${res.name}, Age: ${res.age} – already marked Present`;
  } else if(res.status === "not_found"){
    msg.style.color="red";
    msg.innerText = "❌ Participant not found";
  }
}
</script>
</body>
</html>
